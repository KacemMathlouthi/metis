"""init

Revision ID: e046b977f8a9
Revises:
Create Date: 2025-12-12 23:34:37.673221

"""

from collections.abc import Sequence

import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

from alembic import op

# revision identifiers, used by Alembic.
revision: str = "e046b977f8a9"
down_revision: str | Sequence[str] | None = None
branch_labels: str | Sequence[str] | None = None
depends_on: str | Sequence[str] | None = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table(
        "users",
        sa.Column(
            "github_id",
            sa.Integer(),
            nullable=False,
            comment="GitHub user ID (immutable)",
        ),
        sa.Column("username", sa.String(length=255), nullable=False),
        sa.Column("email", sa.String(length=255), nullable=True),
        sa.Column("avatar_url", sa.String(length=500), nullable=True),
        sa.Column(
            "access_token",
            sa.String(length=500),
            nullable=False,
            comment="Encrypted GitHub OAuth token",
        ),
        sa.Column(
            "refresh_token",
            sa.String(length=500),
            nullable=True,
            comment="Encrypted refresh token",
        ),
        sa.Column("is_active", sa.Boolean(), nullable=False),
        sa.Column("last_login_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("created_at", sa.DateTime(timezone=True), nullable=False),
        sa.Column("updated_at", sa.DateTime(timezone=True), nullable=False),
        sa.PrimaryKeyConstraint("id"),
    )
    op.create_index(op.f("ix_users_github_id"), "users", ["github_id"], unique=True)
    op.create_index(op.f("ix_users_id"), "users", ["id"], unique=False)
    op.create_index(op.f("ix_users_is_active"), "users", ["is_active"], unique=False)
    op.create_index(op.f("ix_users_username"), "users", ["username"], unique=False)
    op.create_table(
        "installations",
        sa.Column(
            "github_installation_id",
            sa.Integer(),
            nullable=False,
            comment="GitHub App installation ID",
        ),
        sa.Column("user_id", sa.UUID(), nullable=False),
        sa.Column(
            "account_type",
            sa.Enum("USER", "ORGANIZATION", name="account_type_enum"),
            nullable=False,
            comment="Whether installed on user account or org",
        ),
        sa.Column("account_name", sa.String(length=255), nullable=False),
        sa.Column(
            "repository",
            sa.String(length=500),
            nullable=False,
            comment="Repository in format 'owner/repo'",
        ),
        sa.Column(
            "config",
            postgresql.JSONB(astext_type=sa.Text()),
            nullable=False,
            comment="ReviewerConfig as JSON: sensitivity, custom_instructions, etc.",
        ),
        sa.Column("is_active", sa.Boolean(), nullable=False),
        sa.Column("suspended_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("created_at", sa.DateTime(timezone=True), nullable=False),
        sa.Column("updated_at", sa.DateTime(timezone=True), nullable=False),
        sa.ForeignKeyConstraint(["user_id"], ["users.id"], ondelete="CASCADE"),
        sa.PrimaryKeyConstraint("id"),
    )
    op.create_index(
        op.f("ix_installations_account_name"),
        "installations",
        ["account_name"],
        unique=False,
    )
    op.create_index(
        op.f("ix_installations_github_installation_id"),
        "installations",
        ["github_installation_id"],
        unique=True,
    )
    op.create_index(op.f("ix_installations_id"), "installations", ["id"], unique=False)
    op.create_index(
        op.f("ix_installations_is_active"), "installations", ["is_active"], unique=False
    )
    op.create_index(
        op.f("ix_installations_repository"),
        "installations",
        ["repository"],
        unique=False,
    )
    op.create_index(op.f("ix_installations_user_id"), "installations", ["user_id"], unique=False)
    op.create_table(
        "reviews",
        sa.Column("installation_id", sa.UUID(), nullable=False),
        sa.Column("pr_number", sa.Integer(), nullable=False),
        sa.Column("repository", sa.String(length=500), nullable=False),
        sa.Column(
            "commit_sha",
            sa.String(length=40),
            nullable=False,
            comment="Git commit SHA being reviewed",
        ),
        sa.Column(
            "status",
            sa.Enum(
                "PENDING",
                "PROCESSING",
                "COMPLETED",
                "FAILED",
                name="review_status_enum",
            ),
            nullable=False,
        ),
        sa.Column("review_text", sa.Text(), nullable=True, comment="Overall review summary"),
        sa.Column(
            "pr_metadata",
            postgresql.JSONB(astext_type=sa.Text()),
            nullable=True,
            comment="PR title, author, description, file count, etc.",
        ),
        sa.Column("started_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("completed_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("error", sa.Text(), nullable=True, comment="Error message if status=FAILED"),
        sa.Column(
            "github_review_id",
            sa.Integer(),
            nullable=True,
            comment="GitHub API review ID",
        ),
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("created_at", sa.DateTime(timezone=True), nullable=False),
        sa.Column("updated_at", sa.DateTime(timezone=True), nullable=False),
        sa.ForeignKeyConstraint(["installation_id"], ["installations.id"], ondelete="CASCADE"),
        sa.PrimaryKeyConstraint("id"),
    )
    op.create_index(op.f("ix_reviews_completed_at"), "reviews", ["completed_at"], unique=False)
    op.create_index(op.f("ix_reviews_id"), "reviews", ["id"], unique=False)
    op.create_index(
        op.f("ix_reviews_installation_id"), "reviews", ["installation_id"], unique=False
    )
    op.create_index(op.f("ix_reviews_pr_number"), "reviews", ["pr_number"], unique=False)
    op.create_index(op.f("ix_reviews_repository"), "reviews", ["repository"], unique=False)
    op.create_index(op.f("ix_reviews_status"), "reviews", ["status"], unique=False)
    op.create_table(
        "review_comments",
        sa.Column("review_id", sa.UUID(), nullable=False),
        sa.Column("file_path", sa.String(length=1000), nullable=False),
        sa.Column("line_number", sa.Integer(), nullable=False),
        sa.Column("line_end", sa.Integer(), nullable=True, comment="For multi-line comments"),
        sa.Column("comment_text", sa.Text(), nullable=False),
        sa.Column(
            "severity",
            sa.Enum("INFO", "WARNING", "ERROR", "CRITICAL", name="severity_enum"),
            nullable=False,
        ),
        sa.Column(
            "category",
            sa.Enum(
                "BUG",
                "SECURITY",
                "PERFORMANCE",
                "STYLE",
                "MAINTAINABILITY",
                "DOCUMENTATION",
                "TESTING",
                name="category_enum",
            ),
            nullable=False,
        ),
        sa.Column(
            "github_comment_id",
            sa.Integer(),
            nullable=True,
            comment="GitHub API comment ID",
        ),
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("created_at", sa.DateTime(timezone=True), nullable=False),
        sa.Column("updated_at", sa.DateTime(timezone=True), nullable=False),
        sa.ForeignKeyConstraint(["review_id"], ["reviews.id"], ondelete="CASCADE"),
        sa.PrimaryKeyConstraint("id"),
    )
    op.create_index(
        op.f("ix_review_comments_category"),
        "review_comments",
        ["category"],
        unique=False,
    )
    op.create_index(
        op.f("ix_review_comments_file_path"),
        "review_comments",
        ["file_path"],
        unique=False,
    )
    op.create_index(op.f("ix_review_comments_id"), "review_comments", ["id"], unique=False)
    op.create_index(
        op.f("ix_review_comments_review_id"),
        "review_comments",
        ["review_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_review_comments_severity"),
        "review_comments",
        ["severity"],
        unique=False,
    )
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f("ix_review_comments_severity"), table_name="review_comments")
    op.drop_index(op.f("ix_review_comments_review_id"), table_name="review_comments")
    op.drop_index(op.f("ix_review_comments_id"), table_name="review_comments")
    op.drop_index(op.f("ix_review_comments_file_path"), table_name="review_comments")
    op.drop_index(op.f("ix_review_comments_category"), table_name="review_comments")
    op.drop_table("review_comments")
    op.drop_index(op.f("ix_reviews_status"), table_name="reviews")
    op.drop_index(op.f("ix_reviews_repository"), table_name="reviews")
    op.drop_index(op.f("ix_reviews_pr_number"), table_name="reviews")
    op.drop_index(op.f("ix_reviews_installation_id"), table_name="reviews")
    op.drop_index(op.f("ix_reviews_id"), table_name="reviews")
    op.drop_index(op.f("ix_reviews_completed_at"), table_name="reviews")
    op.drop_table("reviews")
    op.drop_index(op.f("ix_installations_user_id"), table_name="installations")
    op.drop_index(op.f("ix_installations_repository"), table_name="installations")
    op.drop_index(op.f("ix_installations_is_active"), table_name="installations")
    op.drop_index(op.f("ix_installations_id"), table_name="installations")
    op.drop_index(op.f("ix_installations_github_installation_id"), table_name="installations")
    op.drop_index(op.f("ix_installations_account_name"), table_name="installations")
    op.drop_table("installations")
    op.drop_index(op.f("ix_users_username"), table_name="users")
    op.drop_index(op.f("ix_users_is_active"), table_name="users")
    op.drop_index(op.f("ix_users_id"), table_name="users")
    op.drop_index(op.f("ix_users_github_id"), table_name="users")
    op.drop_table("users")
    # ### end Alembic commands ###
